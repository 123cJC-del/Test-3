<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visite IA ‚Äì D√©mo (Matterport)</title>

<!-- SDK Matterport -->
<script src="https://static.matterport.com/showcase-sdk/latest.js"></script>

<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --brand:#3b82f6; --brand-2:#2563eb; --chip:#eef2ff;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1400px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden}
  .head{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--line)}
  .body{display:grid;grid-template-columns:2fr 1fr}
  @media (max-width:960px){ .body{grid-template-columns:1fr} }

  /* Viewer */
  .viewer{position:relative;min-height:750px;background:#e6ecf3}
  .hotspot{position:absolute;padding:6px 10px;border-radius:999px;background:var(--chip);color:#374151;font-size:13px;
           display:flex;align-items:center;gap:6px;border:1px solid var(--line);box-shadow:0 1px 0 rgba(0,0,0,.03)}
  .hotspot i{width:18px;height:18px;border-radius:999px;background:#dbeafe;display:inline-block}
  .controls{position:absolute;left:16px;bottom:16px;display:flex;gap:10px;align-items:center}
  .pill{background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(6px);border:1px solid var(--line);padding:8px 10px;border-radius:12px}
  .tabs{display:flex;gap:8px}
  .tab{padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:14px;cursor:pointer}
  .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
  .narrBar{position:absolute;left:0;right:0;bottom:0;background:rgba(255,255,255,.96);padding:10px 16px;border-top:1px solid var(--line);display:flex;align-items:center;gap:10px}
  .narrText{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#111827}

  /* Avatar avec images (ferm√©e / ouverte) */
  .avatar {
    position: absolute;
    right: 12px;
    bottom: 12px;
    width: 90px;
    height: 90px;
    border-radius: 16px;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--line);
    box-shadow: 0 6px 20px rgba(0,0,0,.08);
    overflow: hidden;
  }
  .face{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:contain;
    display:none;
  }
  .face-closed{ display:block; }
  .avatar.talking .face-closed{ display:none; }
  .avatar.talking .face-open{ display:block; }

  /* Side / Chat */
  .side{border-left:1px solid var(--line);background:#fafafa;display:flex;flex-direction:column;min-height:750px}
  .sideHead{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line);font-weight:600}
  .chat{flex:1;overflow:auto;padding:12px 12px 0}
  .msg{max-width:92%;padding:10px 12px;border-radius:12px;margin:6px 0;line-height:1.35;font-size:15px}
  .me{margin-left:auto;background:#dbeafe}
  .bot{background:#fff;border:1px solid var(--line)}
  .chatFoot{padding:12px;border-top:1px solid var(--line);display:flex;gap:8px}
  .chatFoot input{flex:1;padding:10px 12px;border-radius:12px;border:1px solid #d1d5db;font-size:15px}
  .btn{padding:10px 14px;border-radius:12px;border:0;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
  .lead{padding:12px;border-top:1px dashed var(--line)}
  .lead .cta{width:100%;padding:10px 14px;border-radius:10px;border:0;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}

  /* Modal (soft-gate) */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.5);display:none;align-items:center;justify-content:center;padding:16px}
  .modal.on{display:flex}
  .sheet{background:#fff;max-width:420px;width:100%;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.2);overflow:hidden}
  .sheet .h{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:700}
  .sheet .c{padding:14px 16px;display:grid;gap:10px}
  .sheet input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #d1d5db}
  .sheet .row{display:flex;gap:10px}
  .sheet .row > *{flex:1}
  .sheet .actions{padding:14px 16px;border-top:1px solid var(--line);display:flex;gap:10px}
  .sheet .actions button{flex:1}
  .small{color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div><strong id="title">3P r√©nov√© ‚Äì 72 m¬≤ ‚Äì Nice</strong></div>
        <div style="color:#111827;font-weight:700" id="price">520 000 ‚Ç¨</div>
      </div>

      <div class="body">
        <!-- ================== VIEWER (Matterport) ================== -->
        <div class="viewer" id="viewer">
          <!-- 1) Mets TON ID apr√®s m=  -->
          <iframe
            id="mp"
            src="https://my.matterport.com/show/?m=9gmG66cA2Sc&play=1&qs=1&brand=0&dh=1&sdk=1"
            allow="fullscreen; xr-spatial-tracking"
            style="position:absolute; inset:0; width:100%; height:100%; border:0;"
          ></iframe>

          <!-- Mini contr√¥les (tu peux les enlever si tu veux) -->
          <div class="controls pill">
            <div title="Son sur clic sur mobile">üéß</div>
            <div class="tabs">
              <button class="tab" data-room="salon">Salon</button>
              <button class="tab" data-room="cuisine">Cuisine</button>
              <button class="tab" data-room="chambre">Chambre</button>
            </div>
          </div>

          <!-- Bandeau de narration -->
          <div class="narrBar">
            <div id="narrText" class="narrText">‚Äî</div>
          </div>

          <!-- AVATAR (2 images, ferm√©/ouvert) -->
          <div class="avatar" id="avatar">
            <!-- ‚ö† fichiers √† la racine du repo -->
            <img class="face face-closed" src="avatar-closed.png" alt="Assistant IA" />
            <img class="face face-open"   src="avatar-open.png"   alt="" />
          </div>

        </div> <!-- üëà FIN du .viewer -->

        <!-- ================== CHAT ================== -->
        <div class="side">
          <div class="sideHead">
            <span>Assistant IA</span>
            <button id="openChat" class="btn" style="padding:8px 12px;">Ouvrir</button>
          </div>
          <div id="chat" class="chat" aria-live="polite"></div>
          <div class="chatFoot">
            <input id="question" placeholder="Pose ta question‚Ä¶ (charges, DPE, copro‚Ä¶)" />
            <button id="send" class="btn">Envoyer</button>
          </div>
          <div class="lead">
            <button id="ctaLead" class="cta">√ätre rappel√©</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SOFT-GATE (modal email) -->
  <div class="modal" id="gate">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
      <div class="h" id="gateTitle">üéüÔ∏è Continue la visite & pose tes questions</div>
      <div class="c">
        <div class="small">Tu recevras le r√©cap par email.</div>
        <input id="leadEmail" type="email" placeholder="Email (obligatoire)" required />
        <div class="row">
          <input id="leadFirst" type="text" placeholder="Pr√©nom" />
          <input id="leadPhone" type="tel" placeholder="T√©l√©phone (facultatif)" />
        </div>
        <label class="small"><input id="consent" type="checkbox" /> J‚Äôaccepte d‚Äô√™tre recontact√© au sujet de ce bien.</label>
      </div>
      <div class="actions">
        <button id="gateGo" class="btn" disabled>Continuer</button>
        <button id="gateSkip" class="btn" style="background:#e5e7eb;color:#111;">Plus tard</button>
      </div>
    </div>
  </div>

  <!-- Lecteur audio commun (pour prochaines int√©grations TTS/MP3) -->
  <audio id="narrAudio" preload="auto"></audio>

<script>
/* ===================== 1) DONN√âES DU BIEN ===================== */
const DATA = {
  titre: "3P r√©nov√© ‚Äì 72 m¬≤ ‚Äì Nice",
  prix: 520000,
  hotspots: ["Exposition Sud", "Baie vitr√©e"],
  charges_mensuelles: 150,
  dpe: "C",
  copro: "Aucune proc√©dure connue",
  surface_totale: 72,
  rooms: {
    salon: {
      titre: "Salon",
      narration: "Bienvenueüëã dans le salon de 22 m¬≤, expos√© plein Sud. La grande baie vitr√©e apporte une luminosit√© constante et le parquet r√©nov√© en 2023 cr√©e une atmosph√®re chaleureuse.",
      audio: "salon.mp3"
    },
    cuisine: {
      titre: "Cuisine",
      narration: "Voici la cuisine semi-ouverte de 10 m¬≤. Enti√®rement √©quip√©e, elle offre de nombreux rangements et reste connect√©e √† l‚Äôespace de vie principal.",
      audio: "cuisine.mp3"
    },
    chambre: {
      titre: "Chambre",
      narration: "La chambre principale de 12 m¬≤ donne sur une cour calme. Elle dispose d‚Äôun placard int√©gr√© et permet facilement l‚Äôam√©nagement d‚Äôun coin bureau.",
      audio: "chambre.mp3"
    }
  }
};

/* ===================== 2) √âTAT + R√àGLES ===================== */
let activeRoom = "salon";
let lastPlayedAt = {};                // { roomId: timestamp }
const COOLDOWN_MS = 25000;            // √©viter relance imm√©diate
let gateShown = false;                // affich√© une fois

const avatarEl   = document.getElementById('avatar');
const narrTextEl = document.getElementById('narrText');
const chatEl     = document.getElementById('chat');
const narrAudio  = document.getElementById('narrAudio');

// === Avatar: √©l√©ments & √©tat
const faceClosedEl = document.querySelector('.face.face-closed');
const faceOpenEl   = document.querySelector('.face.face-open');
let mouthTimer = null;
let mouthOpen  = false;

/* ===================== 3) INIT UI ===================== */
document.getElementById('title').textContent = DATA.titre;
document.getElementById('price').textContent = DATA.prix.toLocaleString('fr-FR') + " ‚Ç¨";
document.getElementById('hs1').textContent = DATA.hotspots[0] || "";
document.getElementById('hs2').textContent = DATA.hotspots[1] || "";

// tabs (manuels, utiles pour tester sans Matterport)
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=> enterRoom(btn.dataset.room));
});

// chat open triggers soft-gate (une fois)
document.getElementById('openChat').addEventListener('click', ()=>{
  if (!gateShown && !localStorage.getItem('lead_email')) openGate();
});

// send question
document.getElementById('send').addEventListener('click', onSend);
document.getElementById('question').addEventListener('keydown',(e)=>{
  if(e.key==='Enter') onSend();
});

// CTA lead
document.getElementById('ctaLead').addEventListener('click', openGate);

// Soft-gate handlers
const gateEl = document.getElementById('gate');
const gateGo = document.getElementById('gateGo');
document.getElementById('gateSkip').addEventListener('click', ()=> { gateEl.classList.remove('on'); });
document.getElementById('leadEmail').addEventListener('input', ()=> validateGate());
document.getElementById('consent').addEventListener('change', ()=> validateGate());
gateGo.addEventListener('click', ()=>{
  const email = document.getElementById('leadEmail').value.trim();
  const first = document.getElementById('leadFirst').value.trim();
  const phone = document.getElementById('leadPhone').value.trim();
  localStorage.setItem('lead_email', email);
  localStorage.setItem('lead_first', first);
  localStorage.setItem('lead_phone', phone);
  console.log("LEAD:", {email, first, phone, property: DATA.titre});
  gateEl.classList.remove('on');
  gateShown = true;
  appendMsg("Merci ! Tu peux continuer la visite et poser tes questions. (Nous t'enverrons le r√©cap par email.)", 'bot');
});

/* ===================== 4) FONCTIONS UI + ANIM BOUCHE ===================== */
function validateGate(){
  const ok = document.getElementById('leadEmail').value.includes('@')
          && document.getElementById('consent').checked;
  gateGo.disabled = !ok;
}
function openGate(){ gateEl.classList.add('on'); validateGate(); }

function appendMsg(text, who='bot'){
  const div = document.createElement('div');
  div.className = `msg ${who==='me'?'me':'bot'}`;
  div.textContent = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

// --- Animation bouche (images ferm√©e / ouverte) ---
function startMouthAnimation(){
  if (mouthTimer) clearInterval(mouthTimer);
  mouthOpen = false;
  if (avatarEl) avatarEl.classList.add('talking');
  if (faceClosedEl && faceOpenEl){
    faceClosedEl.style.display = 'block';
    faceOpenEl.style.display   = 'none';
  }
  // alterne toutes les ~120‚Äì200 ms (ajuste si tu veux)
  mouthTimer = setInterval(()=>{
    mouthOpen = !mouthOpen;
    if (faceClosedEl && faceOpenEl){
      faceClosedEl.style.display = mouthOpen ? 'none'  : 'block';
      faceOpenEl.style.display   = mouthOpen ? 'block' : 'none';
    }
  }, 180);
}

function stopMouthAnimation(){
  if (avatarEl) avatarEl.classList.remove('talking');
  if (mouthTimer){
    clearInterval(mouthTimer);
    mouthTimer = null;
  }
  mouthOpen = false;
  if (faceClosedEl && faceOpenEl){
    faceClosedEl.style.display = 'block';
    faceOpenEl.style.display   = 'none';
  }
}

// Branchements audio (MP3)
narrAudio.onplay  = startMouthAnimation;
narrAudio.onended = stopMouthAnimation;
narrAudio.onpause = stopMouthAnimation;

// TTS navigateur (fallback)
function speak(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'fr-FR';
    u.onstart = startMouthAnimation;
    u.onend   = stopMouthAnimation;

    // stoppe ce qui parlait avant
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch(e){}
}

// Lecture d'un MP3 (pour narrations pr√©-g√©n√©r√©es)
function playRoomAudio(roomId){
  const src = DATA.rooms[roomId].audio;
  if (!src) return false;
  narrAudio.src = src;
  narrAudio.currentTime = 0;
  const playPromise = narrAudio.play();
  if (playPromise && playPromise.catch) playPromise.catch(()=>{ /* mobile: besoin 1er clic */ });
  return true;
}

// Entr√©e de pi√®ce
function enterRoom(roomId){
  if(!DATA.rooms[roomId]) return;
  const now = Date.now();
  if(activeRoom===roomId && now - (lastPlayedAt[roomId]||0) < COOLDOWN_MS){ return; }
  activeRoom = roomId;

  const text = DATA.rooms[roomId].narration;
  document.getElementById('narrText').textContent = text;
  appendMsg(text, 'bot');

  // D'abord MP3 s'il existe, sinon TTS
  if (!playRoomAudio(roomId)) speak(text);

  lastPlayedAt[roomId] = now;

  if(!gateShown && !localStorage.getItem('lead_email')){
    setTimeout(()=>{ if(!gateShown) openGate(); }, 8000);
  }
}

function onSend(){
  const input = document.getElementById('question');
  const q = input.value.trim();
  if(!q) return;

  // Interrompt toute parole en cours + stop anim bouche
  try { narrAudio.pause(); } catch(e){}
  speechSynthesis.cancel();
  stopMouthAnimation();

  appendMsg(q, 'me');
  const reply = answerFromData(q);
  appendMsg(reply, 'bot');

  // voix
  speak(reply);
  input.value='';
}

// R√©ponses depuis nos donn√©es (pas d'invention)
function answerFromData(q){
  const s = q.toLowerCase();
  if(s.includes('charge')) return `Charges mensuelles : ${DATA.charges_mensuelles} ‚Ç¨`;
  if(s.includes('dpe')) return `DPE : ${DATA.dpe}`;
  if(s.includes('prix') || s.includes('co√ªt') || s.includes('cout')) return `Prix demand√© : ${DATA.prix.toLocaleString('fr-FR')} ‚Ç¨`;
  if(s.includes('surface')) return `Surface totale : ${DATA.surface_totale} m¬≤`;
  if(s.includes('copro')) return `Copropri√©t√© : ${DATA.copro}`;
  return `Information non disponible ici. Je peux demander √† un conseiller de vous rappeler si vous voulez.`;
}

/* ===================== 5) MATTERPORT : connexion & mapping ===================== */
(async function connectMatterport(){
  const iframe = document.getElementById('mp');
  if (!iframe) return;

  // IMPORTANT : init du mapping AVANT l'abonnement
  window.SWEEP_TO_ROOM = {};

  let mpSdk;
  try {
    // 1) auto (sans version)
    mpSdk = await window.MP_SDK.connect(iframe);
    console.log("‚úÖ SDK connect√© (auto) !");
  } catch(e1){
    console.warn("Connexion auto √©chou√©e, test des versions‚Ä¶");
    const candidates = ['3.11','3.10','3.9','3.8','3.7','3.6'];
    let lastError = e1;
    for (const v of candidates) {
      try {
        mpSdk = await window.MP_SDK.connect(iframe, v);
        console.log("‚úÖ SDK connect√© avec la version", v);
        lastError = null;
        break;
      } catch (e) {
        lastError = e;
      }
    }
    if (!mpSdk) {
      console.error("‚ùå Erreur SDK Matterport (toutes versions test√©es):", lastError);
      return;
    }
  }

  // 1) TEMPORAIRE: log l'ID de chaque position (sweep) dans la console
  mpSdk.Sweep.current.subscribe((sweepId) => {
    console.log("Sweep actuel:", sweepId);
    const room = window.SWEEP_TO_ROOM[sweepId];
    if (room) enterRoom(room);
  });

  // 2) ‚ûú Apr√®s avoir not√© les IDs dans la console, remplis :
  // window.SWEEP_TO_ROOM = {
  //   "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx": "salon",
  //   "yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy": "cuisine",
  //   "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz": "chambre",
  // };

  // 3) (Optionnel) forcer une premi√®re narration
  // enterRoom('salon');
})();
</script>
</body>
</html>
