<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visite IA ‚Äì D√©mo (Matterport)</title>

<!-- SDK Matterport -->
<script src="https://static.matterport.com/showcase-sdk/latest.js"></script>

<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --brand:#3b82f6; --brand-2:#2563eb;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1400px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden}
  .head{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--line)}
  .body{display:grid;grid-template-columns:2fr 1fr}
  @media (max-width:960px){ .body{grid-template-columns:1fr} }

  /* Viewer */
  .viewer{position:relative;min-height:750px;background:#e6ecf3}
  .controls{position:absolute;left:16px;bottom:16px;display:flex;gap:10px;align-items:center}
  .tabs{display:flex;gap:8px}
  .tab{padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:14px;cursor:pointer}
  .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}

  /* Bulle de parole (remplace la barre du bas) */
  .speech{
    position:absolute;
    right:120px;
    bottom:110px;
    max-width:280px;
    background:#fff;
    padding:10px 14px;
    border-radius:16px;
    border:1px solid var(--line);
    box-shadow:0 6px 20px rgba(0,0,0,.12);
    font-size:14px;
    color:#111827;
    opacity:0;               /* invisible par d√©faut */
    pointer-events:none;
    transition:opacity .25s ease;
  }
  .speech.on{ opacity:1; }
  .speech::after{
    content:"";
    position:absolute;
    bottom:-10px;
    right:20px;
    border-width:10px;
    border-style:solid;
    border-color:#fff transparent transparent transparent;
    filter: drop-shadow(0 -1px 0 rgba(0,0,0,.08));
  }
  .narrText{white-space:normal;line-height:1.3}

  /* Avatar */
  .avatar {
    position: absolute;
    right: 12px;
    bottom: 12px;
    width: 90px;
    height: 90px;
    border-radius: 16px;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--line);
    box-shadow: 0 6px 20px rgba(0,0,0,.08);
    overflow: hidden;
  }
  .face{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; display:none;}
  .face-closed{ display:block; }
  .avatar.talking .face-closed{ display:none; }
  .avatar.talking .face-open{ display:block; }

  /* Side / Chat */
  .side{border-left:1px solid var(--line);background:#fafafa;display:flex;flex-direction:column;min-height:750px}
  .sideHead{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line);font-weight:600}
  .chat{flex:1;overflow:auto;padding:12px 12px 0}
  .msg{max-width:92%;padding:10px 12px;border-radius:12px;margin:6px 0;line-height:1.35;font-size:15px}
  .me{margin-left:auto;background:#dbeafe}
  .bot{background:#fff;border:1px solid var(--line)}
  .chatFoot{padding:12px;border-top:1px solid var(--line);display:flex;gap:8px}
  .chatFoot input{flex:1;padding:10px 12px;border-radius:12px;border:1px solid #d1d5db;font-size:15px}
  .btn{padding:10px 14px;border-radius:12px;border:0;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
  .lead{padding:12px;border-top:1px dashed var(--line)}
  .lead .cta{width:100%;padding:10px 14px;border-radius:10px;border:0;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}

  /* Modal (soft-gate) */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.5);display:none;align-items:center;justify-content:center;padding:16px}
  .modal.on{display:flex}
  .sheet{background:#fff;max-width:420px;width:100%;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.2);overflow:hidden}
  .sheet .h{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:700}
  .sheet .c{padding:14px 16px;display:grid;gap:10px}
  .sheet input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #d1d5db}
  .sheet .row{display:flex;gap:10px}
  .sheet .row > *{flex:1}
  .sheet .actions{padding:14px 16px;border-top:1px solid var(--line);display:flex;gap:10px}
  .sheet .actions button{flex:1}
  .small{color:var(--muted);font-size:12px}

  @media (max-width:960px){
    .viewer{min-height:600px}
    .speech{ right:96px; bottom:96px; max-width:220px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div><strong id="title">3P r√©nov√© ‚Äì 72 m¬≤ ‚Äì Nice</strong></div>
        <div style="color:#111827;font-weight:700" id="price">520 000 ‚Ç¨</div>
      </div>

      <div class="body">
        <!-- ================== VIEWER ================== -->
        <div class="viewer" id="viewer">
          <iframe
            id="mp"
            src="https://my.matterport.com/show/?m=9gmG66cA2Sc&play=1&qs=1&brand=0&dh=1&sdk=1"
            allow="fullscreen; xr-spatial-tracking"
            style="position:absolute; inset:0; width:100%; height:100%; border:0;"
          ></iframe>

          <!-- Contr√¥les -->
          <div class="controls">
            <div class="tabs">
              <button class="tab" data-room="salon">Salon</button>
              <button class="tab" data-room="cuisine">Cuisine</button>
              <button class="tab" data-room="chambre">Chambre</button>
            </div>
          </div>

          <!-- BULLE DE PAROLE -->
          <div class="speech" id="speech" aria-live="polite" aria-atomic="true">
            <div id="narrText" class="narrText">‚Äî</div>
          </div>

          <!-- AVATAR -->
          <div class="avatar" id="avatar">
            <img class="face face-closed" src="avatar-closed.png" alt="Assistant IA" />
            <img class="face face-open"   src="avatar-open.png"   alt="" />
          </div>
        </div>

        <!-- ================== CHAT ================== -->
        <div class="side">
          <div class="sideHead">
            <span>Assistant IA</span>
            <button id="openChat" class="btn" style="padding:8px 12px;">Ouvrir</button>
          </div>
          <div id="chat" class="chat" aria-live="polite"></div>
          <div class="chatFoot">
            <input id="question" placeholder="Pose ta question‚Ä¶ (charges, DPE, copro‚Ä¶)" />
            <button id="send" class="btn">Envoyer</button>
          </div>
          <div class="lead">
            <button id="ctaLead" class="cta">√ätre rappel√©</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SOFT-GATE (modal email) -->
  <div class="modal" id="gate">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
      <div class="h" id="gateTitle">üéüÔ∏è Continue la visite & pose tes questions</div>
      <div class="c">
        <div class="small">Tu recevras le r√©cap par email.</div>
        <input id="leadEmail" type="email" placeholder="Email (obligatoire)" required />
        <div class="row">
          <input id="leadFirst" type="text" placeholder="Pr√©nom" />
          <input id="leadPhone" type="tel" placeholder="T√©l√©phone (facultatif)" />
        </div>
        <label class="small"><input id="consent" type="checkbox" /> J‚Äôaccepte d‚Äô√™tre recontact√© au sujet de ce bien.</label>
      </div>
      <div class="actions">
        <button id="gateGo" class="btn" disabled>Continuer</button>
        <button id="gateSkip" class="btn" style="background:#e5e7eb;color:#111;">Plus tard</button>
      </div>
    </div>
  </div>

  <!-- Lecteur audio commun -->
  <audio id="narrAudio" preload="auto"></audio>

<script>
/* ===================== 1) DONN√âES DU BIEN ===================== */
const DATA = {
  titre: "3P r√©nov√© ‚Äì 72 m¬≤ ‚Äì Nice",
  prix: 520000,
  charges_mensuelles: 150,
  dpe: "C",
  copro: "Aucune proc√©dure connue",
  surface_totale: 72,

  // >>> Intro automatique (texte + MP3)
  introText: "Bonjour et bienvenue üëã Pour profiter pleinement de la visite, activez le son üéß, l‚Äôexp√©rience sera bien plus vivante. Explorez les pi√®ces avec les boutons, et posez-moi vos questions dans le chat. Je suis l√† pour vous aider üòä.",
  introAudio: "intro.mp3",

  rooms: {
    salon: {
      titre: "Salon",
      narration: "Bienvenueüëã dans le salon de 22 m¬≤, expos√© plein Sud. La grande baie vitr√©e apporte une luminosit√© constante et le parquet r√©nov√© en 2023 cr√©e une atmosph√®re chaleureuse.",
      audio: "salon.mp3"
    },
    cuisine: {
      titre: "Cuisine",
      narration: "Voici la cuisine semi-ouverte de 10 m¬≤. Enti√®rement √©quip√©e, elle offre de nombreux rangements et reste connect√©e √† l‚Äôespace de vie principal.",
      audio: "cuisine.mp3"
    },
    chambre: {
      titre: "Chambre",
      narration: "La chambre principale de 12 m¬≤ donne sur une cour calme. Elle dispose d‚Äôun placard int√©gr√© et permet facilement l‚Äôam√©nagement d‚Äôun coin bureau.",
      audio: "chambre.mp3"
    }
  }
};

/* ===================== 2) √âTAT + R√àGLES ===================== */
let activeRoom = "salon";
let lastPlayedAt = {};                // { roomId: timestamp }
const COOLDOWN_MS = 12000;            // √©viter relance imm√©diate
let gateShown = false;                // affich√© une fois

const avatarEl   = document.getElementById('avatar');
const speechEl   = document.getElementById('speech');
const narrTextEl = document.getElementById('narrText');
const chatEl     = document.getElementById('chat');
const narrAudio  = document.getElementById('narrAudio');

// === Avatar: √©l√©ments & √©tat
const faceClosedEl = document.querySelector('.face.face-closed');
const faceOpenEl   = document.querySelector('.face.face-open');
let mouthTimer = null;
let mouthOpen  = false;
let speechHideTimer = null;

/* ===================== 3) INIT UI ===================== */
document.getElementById('title').textContent = DATA.titre;
document.getElementById('price').textContent = DATA.prix.toLocaleString('fr-FR') + " ‚Ç¨";

// Onglets
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=> enterRoom(btn.dataset.room));
});

// Ouvrir chat ‚Üí soft-gate une fois
document.getElementById('openChat').addEventListener('click', ()=>{
  if (!gateShown && !localStorage.getItem('lead_email')) openGate();
});

// Envoi question
document.getElementById('send').addEventListener('click', onSend);
document.getElementById('question').addEventListener('keydown',(e)=>{
  if(e.key==='Enter') onSend();
});

// CTA lead
document.getElementById('ctaLead').addEventListener('click', openGate);

// Soft-gate handlers
const gateEl = document.getElementById('gate');
const gateGo = document.getElementById('gateGo');
document.getElementById('gateSkip').addEventListener('click', ()=> { gateEl.classList.remove('on'); });
document.getElementById('leadEmail').addEventListener('input', ()=> validateGate());
document.getElementById('consent').addEventListener('change', ()=> validateGate());
gateGo.addEventListener('click', ()=>{
  const email = document.getElementById('leadEmail').value.trim();
  const first = document.getElementById('leadFirst').value.trim();
  const phone = document.getElementById('leadPhone').value.trim();
  localStorage.setItem('lead_email', email);
  localStorage.setItem('lead_first', first);
  localStorage.setItem('lead_phone', phone);
  console.log("LEAD:", {email, first, phone, property: DATA.titre});
  gateEl.classList.remove('on');
  gateShown = true;
  appendMsg("Merci ! Tu peux continuer la visite et poser tes questions. (Nous t'enverrons le r√©cap par email.)", 'bot');
});

/* ===================== 4) FONCTIONS UI + ANIM BOUCHE ===================== */
function validateGate(){
  const ok = document.getElementById('leadEmail').value.includes('@')
          && document.getElementById('consent').checked;
  gateGo.disabled = !ok;
}
function openGate(){ gateEl.classList.add('on'); validateGate(); }

function appendMsg(text, who='bot'){
  const div = document.createElement('div');
  div.className = `msg ${who==='me'?'me':'bot'}`;
  div.textContent = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

// --- Bulle: show/hide helpers ---
function showSpeech(){
  if (!speechEl) return;
  clearTimeout(speechHideTimer);
  speechEl.classList.add('on');
}
function hideSpeech(delay=600){
  if (!speechEl) return;
  clearTimeout(speechHideTimer);
  speechHideTimer = setTimeout(()=> speechEl.classList.remove('on'), delay);
}

// --- Animation bouche (images ferm√©e / ouverte) ---
function startMouthAnimation(){
  if (mouthTimer) clearInterval(mouthTimer);
  mouthOpen = false;
  if (avatarEl) avatarEl.classList.add('talking');
  if (faceClosedEl && faceOpenEl){
    faceClosedEl.style.display = 'block';
    faceOpenEl.style.display   = 'none';
  }
  showSpeech();
  mouthTimer = setInterval(()=>{
    mouthOpen = !mouthOpen;
    if (faceClosedEl && faceOpenEl){
      faceClosedEl.style.display = mouthOpen ? 'none'  : 'block';
      faceOpenEl.style.display   = mouthOpen ? 'block' : 'none';
    }
  }, 180);
}

function stopMouthAnimation(){
  if (avatarEl) avatarEl.classList.remove('talking');
  if (mouthTimer){
    clearInterval(mouthTimer);
    mouthTimer = null;
  }
  mouthOpen = false;
  if (faceClosedEl && faceOpenEl){
    faceClosedEl.style.display = 'block';
    faceOpenEl.style.display   = 'none';
  }
  hideSpeech(); // cache la bulle juste apr√®s la fin de la parole
}

// Branchements audio (MP3)
narrAudio.onplay  = startMouthAnimation;
narrAudio.onended = stopMouthAnimation;
narrAudio.onpause = stopMouthAnimation;

// TTS navigateur (fallback)
function speak(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'fr-FR';
    u.onstart = startMouthAnimation;
    u.onend   = stopMouthAnimation;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch(e){}
}

// Lecture d'un MP3 (pr√©-g√©n√©r√©) + cache-bust
function playSrc(src){
  if (!src) return false;
  const withBust = src + (src.includes('?') ? '&' : '?') + 'v=' + Date.now();
  narrAudio.src = withBust;
  narrAudio.currentTime = 0;
  const p = narrAudio.play();
  if (p && p.catch) p.catch(()=>{ /* autoplay peut √™tre bloqu√©, on g√®re ailleurs */ });
  return true;
}
function playRoomAudio(roomId){
  return playSrc(DATA.rooms[roomId]?.audio);
}

/* ===================== 4bis) INTRO AUTO (MP3 une seule fois) ===================== */
function runIntroOnce(){
  if (localStorage.getItem('intro_done')) return; // d√©j√† fait
  const text = DATA.introText || "";
  if (!text) return;

  // Affiche bulle + chat
  narrTextEl.textContent = text;
  showSpeech();
  appendMsg(text, 'bot');

  // Essaie de jouer le MP3 d'intro, sinon fallback TTS
  const tried = playSrc(DATA.introAudio || "");
  // Si le navigateur bloque l'autoplay, on lance un TTS de secours apr√®s 1s
  setTimeout(()=>{
    if (narrAudio.paused) {
      speak(text);
    }
  }, 1000);

  // Marque comme fait pour ne pas r√©p√©ter √† chaque reload
  localStorage.setItem('intro_done', '1');
}

// D√©clenche l‚Äôintro 2s apr√®s le chargement (laisse le temps √† l‚ÄôUI)
window.addEventListener('load', ()=> setTimeout(runIntroOnce, 2000));

// D√©blocage audio apr√®s 1er clic dans la zone viewer (mobile/Safari)
let audioUnlocked = false;
document.getElementById('viewer').addEventListener('click', ()=>{
  if (audioUnlocked) return;
  audioUnlocked = true;
  try {
    narrAudio.muted = true;
    const p = narrAudio.play();
    if (p && p.finally) {
      p.finally(()=>{ narrAudio.pause(); narrAudio.currentTime = 0; narrAudio.muted = false; });
    } else {
      narrAudio.pause(); narrAudio.currentTime = 0; narrAudio.muted = false;
    }
  } catch(e){}
}, { once:true });

/* ===================== 5) ENTR√âE DE PI√àCE + CHAT ===================== */
function enterRoom(roomId){
  if(!DATA.rooms[roomId]) return;
  const now = Date.now();
  if(activeRoom===roomId && now - (lastPlayedAt[roomId]||0) < COOLDOWN_MS){ return; }
  activeRoom = roomId;

  const text = DATA.rooms[roomId].narration;
  narrTextEl.textContent = text;
  showSpeech(); // affiche la bulle tout de suite
  appendMsg(text, 'bot');

  // D'abord MP3 s'il existe, sinon TTS
  if (!playRoomAudio(roomId)) {
    speak(text);
    // Si pas d'audio (ou bloqu√©), on cache la bulle apr√®s 10 s
    hideSpeech(10000);
  }

  lastPlayedAt[roomId] = now;

  if(!gateShown && !localStorage.getItem('lead_email')){
    setTimeout(()=>{ if(!gateShown) openGate(); }, 8000);
  }
}

function onSend(){
  const input = document.getElementById('question');
  const q = input.value.trim();
  if(!q) return;

  try { narrAudio.pause(); } catch(e){}
  speechSynthesis.cancel();
  stopMouthAnimation();

  appendMsg(q, 'me');
  const reply = answerFromData(q);
  appendMsg(reply, 'bot');

  // parle (bulle + voix)
  narrTextEl.textContent = reply;
  showSpeech();
  speak(reply);
  input.value='';
}

// R√©ponses depuis nos donn√©es (pas d'invention)
function answerFromData(q){
  const s = q.toLowerCase();
  if(s.includes('charge')) return `Charges mensuelles : ${DATA.charges_mensuelles} ‚Ç¨`;
  if(s.includes('dpe')) return `DPE : ${DATA.dpe}`;
  if(s.includes('prix') || s.includes('co√ªt') || s.includes('cout')) return `Prix demand√© : ${DATA.prix.toLocaleString('fr-FR')} ‚Ç¨`;
  if(s.includes('surface')) return `Surface totale : ${DATA.surface_totale} m¬≤`;
  if(s.includes('copro')) return `Copropri√©t√© : ${DATA.copro}`;
  return `Information non disponible ici. Je peux demander √† un conseiller de vous rappeler si vous voulez.`;
}

/* ===================== 6) MATTERPORT : connexion & mapping ===================== */
(async function connectMatterport(){
  const iframe = document.getElementById('mp');
  if (!iframe) return;

  window.SWEEP_TO_ROOM = {};

  let mpSdk;
  try {
    mpSdk = await window.MP_SDK.connect(iframe);
    console.log("‚úÖ SDK connect√© (auto) !");
  } catch(e1){
    console.warn("Connexion auto √©chou√©e, test des versions‚Ä¶");
    const candidates = ['3.11','3.10','3.9','3.8','3.7','3.6'];
    let lastError = e1;
    for (const v of candidates) {
      try {
        mpSdk = await window.MP_SDK.connect(iframe, v);
        console.log("‚úÖ SDK connect√© avec la version", v);
        lastError = null;
        break;
      } catch (e) {
        lastError = e;
      }
    }
    if (!mpSdk) {
      console.error("‚ùå Erreur SDK Matterport (toutes versions test√©es):", lastError);
      return;
    }
  }

  // Log du sweep courant (pour futur mapping auto)
  mpSdk.Sweep.current.subscribe((sweepId) => {
    console.log("Sweep actuel:", sweepId);
    const room = window.SWEEP_TO_ROOM[sweepId];
    if (room) enterRoom(room);
  });

  // enterRoom('salon'); // üëâ d√©commente si tu veux d√©marrer direct apr√®s chargement
})();

// Pause auto si l‚Äôonglet n‚Äôest plus visible
document.addEventListener('visibilitychange', ()=>{
  if (document.hidden){
    try{ narrAudio.pause(); }catch(e){}
    speechSynthesis.cancel();
    stopMouthAnimation();
  }
});
</script>
</body>
</html>
